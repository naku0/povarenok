<div>
  @if (user$ | async; as user) {
    <form [formGroup]="recipeForm" (ngSubmit)="onSubmit()" class="recipe-form">
      <h1 class="form-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –≤ –∫–Ω–∏–≥—É</h1>
      <mat-tab-group class="form-tabs">
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>info</mat-icon>
              –û—Å–Ω–æ–≤–Ω–æ–µ
            </div>
          </ng-template>

          <div class="form-section">
            <div class="input-row">
              <div class="input-container">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</mat-label>
                  <input matInput formControlName="name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                  @if (hasError('name')) {
                    <mat-error>{{ getError('name') }}</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="input-container">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</mat-label>
                  <mat-select formControlName="category">
                    <mat-option value="–∑–∞–≤—Ç—Ä–∞–∫">–ó–∞–≤—Ç—Ä–∞–∫</mat-option>
                    <mat-option value="–æ–±–µ–¥">–û–±–µ–¥</mat-option>
                    <mat-option value="—É–∂–∏–Ω">–£–∂–∏–Ω</mat-option>
                    <mat-option value="–¥–µ—Å–µ—Ä—Ç">–î–µ—Å–µ—Ä—Ç</mat-option>
                    <mat-option value="–∑–∞–∫—É—Å–∫–∞">–ó–∞–∫—É—Å–∫–∞</mat-option>
                  </mat-select>
                  @if (hasError('category')) {
                    <mat-error>{{ getError('category') }}</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <div class="input-row">

              <div class="input-container">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>–ö—É—Ö–Ω—è</mat-label>
                  <input matInput formControlName="cuisine" placeholder="–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫—É—Ö–Ω—è">
                </mat-form-field>
              </div>

              <div class="input-container">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</mat-label>
                  <input matInput formControlName="tags" placeholder="—à–æ–∫–æ–ª–∞–¥, –≤—ã–ø–µ—á–∫–∞, —Å–ª–∞–¥–∫–æ–µ">
                </mat-form-field>
              </div>
            </div>
            <div class="input-row">
              <div class="input-container">
                <div class="pic-wrapper">
                  @if (imageUrl) {
                    <img [src]="imageUrl" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤–∞—à–µ–≥–æ –±–ª—é–¥–∞!">
                  }
                </div>
                <div class="pic-buttons">
                  <input type="file" (change)="handlePicChange($event.target!.files)" id="add-pic" accept="image/*">
                  <button matFab extended (click)="document.getElementById('add-pic')?.click()">
                    <mat-icon>upload</mat-icon>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å
                  </button>
                  @if (imageUrl) {
                    <button matFab extended id="delete-btn" (click)="removePic()">
                      <mat-icon>delete</mat-icon>
                      –£–¥–∞–ª–∏—Ç—å
                    </button>
                  } @else {
                    <button matFab extended disabled>
                      <mat-icon>delete</mat-icon>
                      –£–¥–∞–ª–∏—Ç—å
                    </button>
                  }

                </div>
                @if (hasPicError) {
                  <mat-error>{{ picError }}</mat-error>
                }
              </div>
              <div class="input-container">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</mat-label>
                  <textarea matInput formControlName="description" rows="1"
                            placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞"></textarea>
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>schedule</mat-icon>
              –í—Ä–µ–º—è
            </div>
          </ng-template>

          <div class="form-section">
            <div class="time-grid">
              <div class="input-container">
                <mat-form-field appearance="outline">
                  <mat-label>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–º–∏–Ω)</mat-label>
                  <input matInput type="number" formControlName="prepTime" min="0">
                  @if (hasError('prepTime')) {
                    <mat-error>{{ getError('prepTime') }}</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="input-container">
                <mat-form-field appearance="outline">
                  <mat-label>–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (–º–∏–Ω)</mat-label>
                  <input matInput type="number" formControlName="cookTime" min="0">
                  @if (hasError('cookTime')) {
                    <mat-error>{{ getError('cookTime') }}</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="input-container">
                <mat-form-field appearance="outline">
                  <mat-label>–ü–æ—Ä—Ü–∏–∏</mat-label>
                  <input matInput type="number" formControlName="servings" min="1">
                  @if (hasError('servings')) {
                    <mat-error>{{ getError('servings') }}</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <div class="input-container">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</mat-label>
                <mat-select formControlName="difficulty">
                  <mat-option value="–ª–µ–≥–∫–æ">üçÉ –õ–µ–≥–∫–æ</mat-option>
                  <mat-option value="—Å—Ä–µ–¥–Ω–µ">‚ö†Ô∏è –°—Ä–µ–¥–Ω–µ</mat-option>
                  <mat-option value="—Å–ª–æ–∂–Ω–æ">üëπ –°–ª–æ–∂–Ω–æ</mat-option>
                </mat-select>
                @if (hasError('difficulty')) {
                  <mat-error>{{ getError('difficulty') }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>kitchen</mat-icon>
              –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
            </div>
          </ng-template>

          <div class="form-section">
            <div class="ingredients-list">
              <div formArrayName="ingredients">
                @for (ingredient of ingredients.controls; track i; let i = $index) {
                  <div [formGroupName]="i" class="ingredient-item">
                    <div class="ingredient-fields">
                      <mat-form-field appearance="outline" class="amount-field">
                        <mat-label>–ö–æ–ª-–≤–æ</mat-label>
                        <input matInput type="number" formControlName="amount" step="0.1" min="0">
                        @if (hasIngredientError(i, 'amount')) {
                          <mat-error>{{ getIngredientError(i, 'amount') }}</mat-error>
                        }
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="unit-field">
                        <mat-label>–ï–¥.</mat-label>
                        <mat-select formControlName="unit">
                          @for (unit of measurementUnits; track unit) {
                            <mat-option [value]="unit">{{ unit }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="name-field">
                        <mat-label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</mat-label>
                        <input matInput formControlName="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                        @if (hasIngredientError(i, 'name')) {
                          <mat-error>{{ getIngredientError(i, 'name') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>

                    <button mat-icon-button color="warn" (click)="removeIngredient(i)" class="delete-btn">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            </div>

            <button mat-stroked-button type="button" (click)="addIngredient()" class="add-btn">
              <mat-icon>add</mat-icon>
              –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
            </button>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>list</mat-icon>
              –®–∞–≥–∏
            </div>
          </ng-template>

          <div class="form-section">
            <div class="steps-list">
              <div formArrayName="steps">
                @for (step of steps.controls; track i; let i = $index) {
                  <div [formGroupName]="i" class="step-item">
                    <div class="step-header">
                      <span class="step-number">–®–∞–≥ {{ i + 1 }}</span>
                      <button mat-icon-button color="warn" (click)="removeStep(i)" class="delete-btn">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>

                    <div class="step-content">
                      <mat-form-field appearance="outline" class="duration-field">
                        <mat-label>–í—Ä–µ–º—è (–º–∏–Ω)</mat-label>
                        <input matInput type="number" formControlName="duration" min="0">
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="instruction-field">
                        <mat-label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</mat-label>
                        <textarea matInput formControlName="instruction" rows="1"
                                  placeholder="–û–ø–∏—à–∏—Ç–µ —à–∞–≥ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è"></textarea>
                        @if (hasStepError(i, 'instruction')) {
                          <mat-error>{{ getStepError(i, 'instruction') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>
                  </div>
                }
              </div>
            </div>
            <button mat-stroked-button type="button" (click)="addStep()" class="add-btn">
              <mat-icon>add</mat-icon>
              –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥
            </button>
          </div>
        </mat-tab>
      </mat-tab-group>

      <div class="form-actions">
        <button mat-button type="button" (click)="onCancel()" class="cancel-btn">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="!recipeForm.valid" class="submit-btn">
          <mat-icon>save</mat-icon>
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç
        </button>
      </div>
    </form>
  } @else {
    <mat-card class="auth-card">
      <mat-card-content>
        <div class="not-authorized">
          <mat-icon class="auth-icon">lock</mat-icon>
          <h2 class="auth-title">–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
          <p class="auth-description">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</p>
          <button mat-raised-button color="primary" (click)="navigateToLogin()">
            <mat-icon>login</mat-icon>
            –í–æ–π—Ç–∏
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
